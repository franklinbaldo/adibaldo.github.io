---
import { type CollectionEntry, getCollection, render } from 'astro:content';
import BaseHead from '../../components/BaseHead.astro';
import Footer from '../../components/Footer.astro';
import Header from '../../components/Header.astro';
import FormattedDate from '../../components/FormattedDate.astro';
import { SITE_TITLE } from '../../consts';

export async function getStaticPaths() {
	const places = await getCollection('places');
	return places.map((place) => ({
		params: { slug: place.id },
		props: place,
	}));
}

type Props = CollectionEntry<'places'>;
const place = Astro.props;
const { Content } = await render(place);

const posts = (await getCollection('blog'))
	.filter((p) => !p.data.draft)
	.filter((p) => p.data.place === place.id)
	.sort((a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf());

const breadcrumbLD = {
	"@context": "https://schema.org",
	"@type": "BreadcrumbList",
	"itemListElement": [
		{
			"@type": "ListItem",
			"position": 1,
			"name": "Início",
			"item": Astro.site?.toString()
		},
		{
			"@type": "ListItem",
			"position": 2,
			"name": "Locais",
			"item": new URL('/locais', Astro.site).toString()
		},
		{
			"@type": "ListItem",
			"position": 3,
			"name": place.data.title
		}
	]
};
---

<!doctype html>
<html lang="pt-BR">
	<head>
		<BaseHead
			title={`${place.data.title} — Locais — ${SITE_TITLE}`}
			description={place.data.summary}
		/>
		<script type="application/ld+json" set:html={JSON.stringify(breadcrumbLD)} />
	</head>
	<body>
		<Header />

		<section class="hero">
			<div class="container hero-inner">
				<h1 style="font-size: clamp(34px, 4.5vw, 56px);">{place.data.title}</h1>
				<p class="hero-kicker">{place.data.summary}</p>
			</div>
		</section>

		<main class="section">
			<div class="container">
				<div class="reading-width" style="margin-bottom: var(--space-xl);">
					<article class="prose">
						<Content />
					</article>
				</div>

				<div class="section-title">
					<h2 style="margin:0;">Textos deste lugar</h2>
					<a href="/textos">Ver todos</a>
				</div>

				{posts.length === 0 ? (
					<p class="meta">Ainda não tem texto publicado aqui. Mas isso se ajeita.</p>
				) : (
					<div class="grid">
						{posts.map((post) => (
							<a class="card" href={`/textos/${post.id}/`}>
								<div class="tag-row">
									{post.data.tags?.slice(0, 1).map((t) => (
										<span class="tag">{t}</span>
									))}
								</div>
								<h3 class="card-title">{post.data.title}</h3>
								<p class="card-desc">{post.data.description}</p>
								<p class="meta" style="margin:0;">
									<FormattedDate date={post.data.pubDate} />
								</p>
							</a>
						))}
					</div>
				)}
			</div>
		</main>

		<Footer />
	</body>
</html>
